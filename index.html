<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Jump</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow: hidden;
        }
        .game-container {
            max-width: 900px;
            width: 100%;
            background-color: #1a1a2e;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        canvas {
            background-color: #2a2a44;
            border-radius: 0.5rem;
            display: block;
        }
        .ui-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #2a2a44;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .screen-container {
            min-height: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            padding: 2rem;
        }
        .menu-button {
            background-color: #ffcc00;
            color: #1a1a2e;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            cursor: pointer;
            margin: 0.5rem 0;
            width: 250px;
        }
        .menu-button:hover {
            transform: scale(1.05);
        }
        #username-input {
            background-color: #2a2a44;
            border: 2px solid #5b3d2d;
            padding: 0.5rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            color: #fff;
            text-align: center;
        }
        #username-input::placeholder {
            color: #aaa;
        }
        .list-container {
            width: 100%;
            max-width: 400px;
            text-align: left;
            margin-top: 1rem;
        }
        .list-item {
            background-color: #2a2a44;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        .list-item span:first-child {
            font-weight: bold;
        }
        .list-item span:last-child {
            color: #ffcc00;
        }
        .level-clear-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }
        .level-clear-text {
            font-size: 3rem;
            font-weight: bold;
            color: #38a169;
            animation: fadeInOut 2s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Main Menu Screen -->
        <div id="main-menu-screen" class="screen-container">
            <h1 class="text-3xl md:text-5xl font-extrabold mb-4 text-yellow-500">Knowledge Jump</h1>
            <p class="text-lg text-gray-300 mb-8">Jump on the correct platform to win!</p>
            <button id="play-button" class="menu-button">Play</button>
            <button id="achievements-button" class="menu-button">Achievements</button>
            <button id="credits-button" class="menu-button">Credits</button>
        </div>

        <!-- Play Screen (with username input) -->
        <div id="play-screen" class="screen-container hidden">
            <h2 class="text-3xl font-extrabold mb-4 text-yellow-500">Enter your name</h2>
            <input type="text" id="username-input" placeholder="Your Name" class="text-center" />
            <div class="controls-info mt-4">
                Use **Left** and **Right** arrow keys to move.<br>
                Use **Up** arrow key to jump.<br>
                Use **Down** arrow key to duck.
            </div>
            <button id="start-game-button" class="menu-button mt-6">Start Game</button>
            <button id="back-to-main-menu-button" class="menu-button">Back</button>
        </div>

        <!-- Achievements Screen -->
        <div id="achievements-screen" class="screen-container hidden">
            <h2 class="text-3xl font-extrabold mb-4 text-yellow-500">Top 5 High Scores</h2>
            <div id="high-score-list" class="list-container">
                <p>Loading...</p>
            </div>
            <button id="back-to-menu-from-achievements" class="menu-button mt-6">Back to Menu</button>
        </div>

        <!-- Credits Screen -->
        <div id="credits-screen" class="screen-container hidden">
            <h2 class="text-3xl font-extrabold mb-4 text-yellow-500">Credits</h2>
            <div class="flex flex-col gap-2 text-lg">
                <p>Sam</p>
                <p>Aadi</p>
                <p>Umang</p>
                <p>Sid</p>
            </div>
            <button id="back-to-menu-from-credits" class="menu-button mt-6">Back to Menu</button>
        </div>

        <!-- Game UI -->
        <div id="game-ui" class="hidden w-full">
            <div class="ui-panel">
                <span id="level-display">Level: 1</span>
                <span id="score-display">Score: 0</span>
            </div>
            <canvas id="game-canvas"></canvas>
        </div>
        
        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen-container hidden">
            <h2 id="game-over-title" class="text-3xl md:text-4xl font-extrabold text-red-500 mb-4">Game Over!</h2>
            <p class="text-xl mb-2">You reached level <span id="final-level"></span></p>
            <p class="text-xl mb-6">Your final score is: <span id="final-score"></span></p>
            <button id="restart-button" class="menu-button">Restart</button>
            <button id="quit-button" class="menu-button">Quit to Menu</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const mainMenuScreen = document.getElementById('main-menu-screen');
        const playScreen = document.getElementById('play-screen');
        const achievementsScreen = document.getElementById('achievements-screen');
        const creditsScreen = document.getElementById('credits-screen');
        const gameUI = document.getElementById('game-ui');
        const gameOverScreen = document.getElementById('game-over-screen');
        const playButton = document.getElementById('play-button');
        const achievementsButton = document.getElementById('achievements-button');
        const creditsButton = document.getElementById('credits-button');
        const startGameButton = document.getElementById('start-game-button');
        const restartButton = document.getElementById('restart-button');
        const quitButton = document.getElementById('quit-button');
        const backToMainMenuButton = document.getElementById('back-to-main-menu-button');
        const backToMenuFromAchievementsButton = document.getElementById('back-to-menu-from-achievements');
        const backToMenuFromCreditsButton = document.getElementById('back-to-menu-from-credits');
        const usernameInput = document.getElementById('username-input');
        const levelDisplay = document.getElementById('level-display');
        const scoreDisplay = document.getElementById('score-display');
        const finalLevelDisplay = document.getElementById('final-level');
        const finalScoreDisplay = document.getElementById('final-score');
        const highScoreList = document.getElementById('high-score-list');

        canvas.width = 800;
        canvas.height = 450;

        let game;
        let animationFrameId;
        let username = 'Anonymous';
        let db;

        const questions = [
            { question: "What is the capital of France?", options: ["London", "Paris", "Berlin", "Rome"], answer: "Paris" },
            { question: "What is the largest ocean on Earth?", options: ["Atlantic Ocean", "Indian Ocean", "Arctic Ocean", "Pacific Ocean"], answer: "Pacific Ocean" },
            { question: "What is the largest organ in the human body?", options: ["Heart", "Liver", "Skin", "Brain"], answer: "Skin" },
            { question: "Who wrote 'Romeo and Juliet'?", options: ["Charles Dickens", "William Shakespeare", "Jane Austen", "Mark Twain"], answer: "William Shakespeare" },
            { question: "What is the chemical symbol for gold?", options: ["Au", "Ag", "Fe", "Pb"], answer: "Au" },
            { question: "Which gas do plants absorb from the atmosphere?", options: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"], answer: "Carbon Dioxide" },
            { question: "What is the currency of Japan?", options: ["Yen", "Euro", "Dollar", "Peso"], answer: "Yen" },
            { question: "Which famous scientist developed the theory of relativity?", options: ["Isaac Newton", "Albert Einstein", "Stephen Hawking", "Marie Curie"], answer: "Albert Einstein" },
            { question: "In what year did the Titanic sink?", options: ["1912", "1915", "1918", "1921"], answer: "1912" },
            { question: "How many continents are there?", options: ["5", "6", "7", "8"], answer: "7" },
            { question: "What is the smallest planet in our solar system?", options: ["Mars", "Mercury", "Pluto", "Earth"], answer: "Mercury" },
            { question: "What is the boiling point of water in Celsius?", options: ["100°C", "0°C", "50°C", "200°C"], answer: "100°C" },
            { question: "What is the longest river in the world?", options: ["Nile", "Amazon", "Yangtze", "Mississippi"], answer: "Nile" },
            { question: "Who painted the Mona Lisa?", options: ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Claude Monet"], answer: "Leonardo da Vinci" },
            { question: "What is the capital of Australia?", options: ["Sydney", "Melbourne", "Canberra", "Perth"], answer: "Canberra" },
            { question: "What is the square root of 64?", options: ["6", "7", "8", "9"], answer: "8" },
            { question: "Which planet is known as the 'Red Planet'?", options: ["Mars", "Jupiter", "Venus", "Saturn"], answer: "Mars" },
            { question: "Who was the first man to walk on the moon?", options: ["Yuri Gagarin", "Buzz Aldrin", "Neil Armstrong", "Michael Collins"], answer: "Neil Armstrong" },
            { question: "What is the largest country in the world by land area?", options: ["China", "Canada", "USA", "Russia"], answer: "Russia" },
            { question: "What is the primary gas found in the Earth's atmosphere?", options: ["Oxygen", "Carbon Dioxide", "Nitrogen", "Argon"], answer: "Nitrogen" },
            { question: "What is the chemical symbol for oxygen?", options: ["O", "Ox", "O2", "Oz"], answer: "O" },
            { question: "What is the hardest natural substance on Earth?", options: ["Gold", "Iron", "Diamond", "Quartz"], answer: "Diamond" },
            { question: "Who wrote the play 'Hamlet'?", options: ["William Shakespeare", "Charles Dickens", "Leo Tolstoy", "Jane Austen"], answer: "William Shakespeare" },
            { question: "What is the capital of Canada?", options: ["Toronto", "Vancouver", "Ottawa", "Montreal"], answer: "Ottawa" },
            { question: "How many bones are in the adult human body?", options: ["206", "210", "200", "198"], answer: "206" },
            { question: "What is the largest mammal?", options: ["Elephant", "Blue Whale", "Giraffe", "Lion"], answer: "Blue Whale" },
            { question: "What is the name of the galaxy our solar system is in?", options: ["Andromeda", "Triangulum", "Milky Way", "Whirlpool"], answer: "Milky Way" },
            { question: "What is the main ingredient in guacamole?", options: ["Tomato", "Avocado", "Onion", "Lime"], answer: "Avocado" },
            { question: "What is the longest bone in the human body?", options: ["Tibia", "Fibula", "Femur", "Humerus"], answer: "Femur" },
            { question: "What is the official language of Brazil?", options: ["Spanish", "Portuguese", "French", "English"], answer: "Portuguese" },
            { question: "What is the capital of China?", options: ["Shanghai", "Beijing", "Hong Kong", "Tokyo"], answer: "Beijing" },
            { question: "What is the most widely spoken language in the world?", options: ["English", "Mandarin Chinese", "Spanish", "Hindi"], answer: "Mandarin Chinese" },
            { question: "What is the chemical formula for water?", options: ["H2O", "CO2", "O2", "NaCl"], answer: "H2O" },
            { question: "Which continent is the Sahara Desert located on?", options: ["Asia", "Australia", "Africa", "South America"], answer: "Africa" },
            { question: "What is the largest city in the world by population?", options: ["Tokyo", "Delhi", "Shanghai", "Mexico City"], answer: "Tokyo" },
            { question: "Who was the first President of the United States?", options: ["Thomas Jefferson", "Abraham Lincoln", "George Washington", "John Adams"], answer: "George Washington" },
            { question: "What is the value of pi?", options: ["3.14", "3.12", "3.16", "3.18"], answer: "3.14" },
            { question: "What is the primary component of the sun?", options: ["Oxygen", "Helium", "Hydrogen", "Carbon"], answer: "Hydrogen" },
            { question: "What is the most common element in the universe?", options: ["Helium", "Oxygen", "Hydrogen", "Carbon"], answer: "Hydrogen" },
            { question: "What is the capital of Italy?", options: ["Venice", "Milan", "Rome", "Naples"], answer: "Rome" },
            { question: "What is the largest country in South America?", options: ["Argentina", "Brazil", "Colombia", "Peru"], answer: "Brazil" },
            { question: "Which famous scientist formulated the laws of motion and universal gravitation?", options: ["Galileo Galilei", "Isaac Newton", "Johannes Kepler", "Nikola Tesla"], answer: "Isaac Newton" },
            { question: "What is the largest state in the USA by land area?", options: ["Texas", "California", "Alaska", "Florida"], answer: "Alaska" },
            { question: "What is the currency of India?", options: ["Yen", "Dollar", "Rupee", "Euro"], answer: "Rupee" },
            { question: "What is the capital of Japan?", options: ["Kyoto", "Osaka", "Tokyo", "Hiroshima"], answer: "Tokyo" },
            { question: "How many planets are in our solar system?", options: ["7", "8", "9", "10"], answer: "8" },
            { question: "Which is the tallest mountain in the world?", options: ["Mount Everest", "K2", "Kangchenjunga", "Lhotse"], answer: "Mount Everest" },
            { question: "What is the name of the largest rainforest in the world?", options: ["Congo", "Valdivian", "Amazon", "Daintree"], answer: "Amazon" },
            { question: "What is the capital of Germany?", options: ["Hamburg", "Munich", "Frankfurt", "Berlin"], answer: "Berlin" },
            { question: "What is the powerhouse of the cell?", options: ["Nucleus", "Ribosome", "Mitochondria", "Cytoplasm"], answer: "Mitochondria" },
            { question: "Who was the first woman to win a Nobel Prize?", options: ["Mother Teresa", "Marie Curie", "Rosalind Franklin", "Jane Goodall"], answer: "Marie Curie" },
            { question: "What is the chemical symbol for table salt?", options: ["NaCl", "KCl", "H2O", "CO2"], answer: "NaCl" },
            { question: "What is the capital of Egypt?", options: ["Luxor", "Cairo", "Giza", "Alexandria"], answer: "Cairo" },
            { question: "What is the main function of the kidneys?", options: ["Digestion", "Filtering blood", "Pumping blood", "Breathing"], answer: "Filtering blood" },
            { question: "Which country is home to the kangaroo?", options: ["New Zealand", "Australia", "South Africa", "Brazil"], answer: "Australia" },
            { question: "Who wrote 'Pride and Prejudice'?", options: ["Charlotte Bronte", "Jane Austen", "Emily Bronte", "Mary Shelley"], answer: "Jane Austen" },
            { question: "What is the capital of South Korea?", options: ["Busan", "Daegu", "Incheon", "Seoul"], answer: "Seoul" },
            { question: "Which gas is most abundant in the air we breathe?", options: ["Oxygen", "Carbon Dioxide", "Nitrogen", "Helium"], answer: "Nitrogen" },
            { question: "What is the largest bird in the world?", options: ["Eagle", "Ostrich", "Emu", "Penguin"], answer: "Ostrich" },
            { question: "How many years are in a millennium?", options: ["100", "500", "1000", "5000"], answer: "1000" },
            { question: "Who painted the Sistine Chapel ceiling?", options: ["Raphael", "Michelangelo", "Leonardo da Vinci", "Donatello"], answer: "Michelangelo" },
            { question: "What is the chemical symbol for iron?", options: ["Ir", "Fe", "In", "Au"], answer: "Fe" },
            { question: "What is the main ingredient of bread?", options: ["Sugar", "Flour", "Salt", "Yeast"], answer: "Flour" },
            { question: "How many sides does a hexagon have?", options: ["5", "6", "7", "8"], answer: "6" },
            { question: "What is the capital of Spain?", options: ["Barcelona", "Madrid", "Seville", "Valencia"], answer: "Madrid" },
            { question: "What is the name of the largest desert in the world?", options: ["Gobi", "Kalahari", "Sahara", "Antarctic"], answer: "Antarctic" },
            { question: "Who was the first man to fly in space?", options: ["Neil Armstrong", "Yuri Gagarin", "Buzz Aldrin", "Alan Shepard"], answer: "Yuri Gagarin" },
            { question: "What is the capital of Russia?", options: ["St. Petersburg", "Moscow", "Kazan", "Sochi"], answer: "Moscow" },
            { question: "What is the main purpose of photosynthesis in plants?", options: ["To release oxygen", "To create food", "To absorb water", "To grow"], answer: "To create food" },
            { question: "What is the primary color of a ripe banana?", options: ["Red", "Green", "Blue", "Yellow"], answer: "Yellow" },
            { question: "Which organ pumps blood throughout the body?", options: ["Lungs", "Brain", "Heart", "Stomach"], answer: "Heart" },
            { question: "What is the chemical symbol for helium?", options: ["He", "H", "Hl", "Hm"], answer: "He" },
            { question: "What is the capital of the United Kingdom?", options: ["Manchester", "London", "Edinburgh", "Cardiff"], answer: "London" },
            { question: "What is the smallest continent by land area?", options: ["Europe", "Australia", "Antarctica", "South America"], answer: "Australia" },
            { question: "What is the capital of Mexico?", options: ["Cancún", "Guadalajara", "Mexico City", "Puebla"], answer: "Mexico City" },
            { question: "How many legs does a spider have?", options: ["6", "8", "10", "12"], answer: "8" },
            { question: "What is the fastest land animal?", options: ["Lion", "Cheetah", "Gazelle", "Leopard"], answer: "Cheetah" },
            { question: "What is the world's most populous country?", options: ["China", "India", "USA", "Indonesia"], answer: "India" },
            { question: "What is the capital of Thailand?", options: ["Chiang Mai", "Phuket", "Bangkok", "Pattaya"], answer: "Bangkok" },
            { question: "Which famous pyramid is located in Egypt?", options: ["Pyramid of Djoser", "Pyramid of Khafre", "Great Pyramid of Giza", "Red Pyramid"], answer: "Great Pyramid of Giza" },
            { question: "What is the chemical symbol for silver?", options: ["Ag", "Au", "Si", "Fe"], answer: "Ag" },
            { question: "What is the capital of Greece?", options: ["Sparta", "Thebes", "Athens", "Corinth"], answer: "Athens" },
            { question: "Which country is famous for the Eiffel Tower?", options: ["Italy", "Spain", "France", "Germany"], answer: "France" },
            { question: "What is the largest animal on Earth?", options: ["Elephant", "Giraffe", "Blue Whale", "Great White Shark"], answer: "Blue Whale" },
            { question: "How many bones are in the human hand?", options: ["25", "27", "29", "31"], answer: "27" },
            { question: "What is the smallest continent in the world?", options: ["Asia", "Europe", "Australia", "Africa"], answer: "Australia" },
            { question: "What is the capital of Sweden?", options: ["Gothenburg", "Malmö", "Uppsala", "Stockholm"], answer: "Stockholm" },
            { question: "What is the chemical formula for salt?", options: ["NaCl", "KCl", "H2O", "CO2"], answer: "NaCl" },
            { question: "Who was the first American in space?", options: ["John Glenn", "Alan Shepard", "Neil Armstrong", "Buzz Aldrin"], answer: "Alan Shepard" },
            { question: "What is the capital of Argentina?", options: ["Buenos Aires", "Cordoba", "Rosario", "Mendoza"], answer: "Buenos Aires" },
            { question: "What is the hardest mineral?", options: ["Talc", "Gypsum", "Diamond", "Quartz"], answer: "Diamond" },
            { question: "What is the largest country in Africa by area?", options: ["Sudan", "Algeria", "Democratic Republic of Congo", "Libya"], answer: "Algeria" },
            { question: "How many teeth does an adult human have?", options: ["28", "30", "32", "34"], answer: "32" },
            { question: "What is the capital of New Zealand?", options: ["Auckland", "Christchurch", "Wellington", "Queenstown"], answer: "Wellington" },
            { question: "What is the largest organ in the human body?", options: ["Brain", "Liver", "Lungs", "Skin"], answer: "Skin" },
            { question: "Who is known as the 'Father of modern physics'?", options: ["Isaac Newton", "Galileo Galilei", "Albert Einstein", "Stephen Hawking"], answer: "Albert Einstein" },
            { question: "What is the capital of Peru?", options: ["Cusco", "Lima", "Arequipa", "Trujillo"], answer: "Lima" },
            { question: "How many legs does a spider have?", options: ["4", "6", "8", "10"], answer: "8" },
            { question: "What is the longest river in the United States?", options: ["Mississippi River", "Missouri River", "Colorado River", "Rio Grande"], answer: "Missouri River" },
            { question: "What is the largest country by population in Africa?", options: ["Egypt", "Nigeria", "Ethiopia", "South Africa"], answer: "Nigeria" },
            { question: "What is the capital of Brazil?", options: ["Rio de Janeiro", "Sao Paulo", "Brasilia", "Salvador"], answer: "Brasilia" },
            { question: "Who was the first person to circumnavigate the Earth?", options: ["Christopher Columbus", "Ferdinand Magellan", "Vasco da Gama", "James Cook"], answer: "Ferdinand Magellan" },
            { question: "How many oceans are there on Earth?", options: ["4", "5", "6", "7"], answer: "5" },
            { question: "What is the highest mountain in North America?", options: ["Mount Rainier", "Mount Denali", "Mount Logan", "Pico de Orizaba"], answer: "Mount Denali" },
            { question: "What is the capital of South Africa?", options: ["Cape Town", "Pretoria", "Johannesburg", "Durban"], answer: "Pretoria" },
            { question: "What is the largest planet in our solar system?", options: ["Saturn", "Jupiter", "Uranus", "Neptune"], answer: "Jupiter" },
            { question: "How many stars are on the flag of the USA?", options: ["40", "50", "52", "55"], answer: "50" }
        ];

        class Player {
            constructor() {
                this.baseHeight = 30;
                this.duckHeight = 15;
                this.width = 16;
                this.height = this.baseHeight;
                this.x = 50;
                this.y = canvas.height - 50;
                this.vx = 0;
                this.vy = 0;
                this.gravity = 0.5;
                this.isJumping = false;
                this.isDucking = false;
                this.rotation = 0;
                this.legOffset = 0;
                this.legDirection = 1;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                ctx.rotate(this.rotation);

                // Body
                ctx.fillStyle = '#b91c1c';
                ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);

                // Head
                ctx.fillStyle = '#fef3c7';
                ctx.beginPath();
                ctx.arc(0, -this.height / 2 - 8, 8, 0, Math.PI * 2);
                ctx.fill();

                // Eyes
                ctx.fillStyle = '#1a1a2e';
                ctx.beginPath();
                ctx.arc(-3, -this.height / 2 - 8, 1.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(3, -this.height / 2 - 8, 1.5, 0, Math.PI * 2);
                ctx.fill();

                // Legs
                ctx.fillStyle = '#2563eb';
                const legWidth = this.width / 2 - 2;
                const legHeight = 5;
                ctx.fillRect(-this.width / 2 + 1 + this.legOffset, this.height / 2, legWidth, legHeight);
                ctx.fillRect(1 - this.legOffset, this.height / 2, legWidth, legHeight);

                ctx.restore();
            }

            update() {
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;

                // Adjust player height for ducking
                if (this.isDucking) {
                    this.height = this.duckHeight;
                } else {
                    this.height = this.baseHeight;
                }

                // Update animations
                if (this.isJumping) {
                    this.rotation += 0.1;
                } else if (!this.isJumping && this.rotation !== 0) {
                    this.rotation = 0;
                }

                if (Math.abs(this.vx) > 0 && !this.isJumping) {
                    this.legOffset += 0.5 * this.legDirection;
                    if (this.legOffset > 3 || this.legOffset < -3) {
                        this.legDirection *= -1;
                    }
                } else {
                    this.legOffset = 0;
                }
                
                // Keep player within canvas bounds
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
            }
        }

        class Platform {
            constructor(x, y, width, height, isCorrect = false, text = '') {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.isCorrect = isCorrect;
                this.text = text;
            }

            draw() {
                // All platforms are the same color now
                ctx.fillStyle = '#5b3d2d'; 
                ctx.fillRect(this.x, this.y, this.width, this.height);
                if (this.text) {
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.font = '16px Inter';
                    ctx.fillText(this.text, this.x + this.width / 2, this.y - 10);
                }
            }
        }

        class Game {
            constructor() {
                this.player = new Player();
                this.platforms = [];
                this.level = 0;
                this.score = 0;
                this.gameOver = false;
                this.keys = {};
                this.currentQuestion = null;
                this.shuffledQuestions = shuffleArray([...questions]);
                this.isLevelCleared = false;
                
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                    if (e.key === 'ArrowDown') {
                        this.player.isDucking = true;
                    }
                });
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                    if (e.key === 'ArrowDown') {
                        this.player.isDucking = false;
                    }
                });

                this.generateLevel();
                this.gameLoop();
            }

            generateLevel() {
                this.level++;
                this.platforms = [];
                this.currentQuestion = this.shuffledQuestions[this.level - 1];
                if (!this.currentQuestion) {
                    this.endGame(true);
                    return;
                }

                // Reset player position for new level
                this.player.x = 50;
                this.player.y = canvas.height - 50;
                this.player.vx = 0;
                this.player.vy = 0;

                this.platforms.push(new Platform(0, canvas.height - 20, canvas.width, 20)); // Ground platform
                
                const questionOptions = shuffleArray([...this.currentQuestion.options]);
                
                // I've adjusted the platform width to make it easier to land on
                const platformWidth = 200; 
                const platformHeight = 20;
                const horizontalSpacing = (canvas.width - (platformWidth * questionOptions.length)) / (questionOptions.length + 1);
                let currentX = horizontalSpacing;

                // Create platforms for the options in a single horizontal line
                for (let i = 0; i < questionOptions.length; i++) {
                    const optionText = questionOptions[i];
                    const isCorrect = optionText === this.currentQuestion.answer;
                    
                    this.platforms.push(new Platform(
                        currentX,
                        canvas.height - 150,
                        platformWidth,
                        platformHeight,
                        isCorrect,
                        optionText
                    ));
                    currentX += platformWidth + horizontalSpacing;
                }
            }

            gameLoop() {
                if (this.gameOver) {
                    cancelAnimationFrame(animationFrameId);
                    return;
                }

                if (!this.isLevelCleared) {
                    this.update();
                    this.draw();
                } else {
                    // Draw "Level Cleared!" animation
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#38a169';
                    ctx.textAlign = 'center';
                    ctx.font = '50px Inter';
                    ctx.fillText("Level Cleared!", canvas.width / 2, canvas.height / 2);
                }

                animationFrameId = requestAnimationFrame(() => this.gameLoop());
            }

            update() {
                this.player.update();

                // Player movement
                this.player.vx = 0;
                if (this.keys['ArrowLeft']) this.player.vx = -5;
                if (this.keys['ArrowRight']) this.player.vx = 5;

                // Player jump
                if (this.keys['ArrowUp'] && !this.player.isJumping) {
                    this.player.vy = -12;
                    this.player.isJumping = true;
                }
                
                // Collision detection
                let onPlatform = false;
                this.platforms.forEach(platform => {
                    if (this.player.vy >= 0 &&
                        this.player.y + this.player.height >= platform.y &&
                        this.player.y + this.player.height <= platform.y + this.player.height &&
                        this.player.x + this.player.width > platform.x &&
                        this.player.x < platform.x + platform.width) {
                        
                        this.player.y = platform.y - this.player.height;
                        this.player.vy = 0;
                        this.player.isJumping = false;
                        onPlatform = true;

                        // Check if the player landed on a question platform
                        if (platform.text) {
                            this.checkAnswer(platform);
                        }
                    }
                });

                // Game over if player falls off the bottom
                if (this.player.y > canvas.height) {
                    this.endGame(false);
                }
                
                // Update UI
                levelDisplay.textContent = `Level: ${this.level}`;
                scoreDisplay.textContent = `Score: ${this.score}`;
            }
            
            async checkAnswer(platform) {
                if (platform.isCorrect) {
                    this.score += 100;
                    this.isLevelCleared = true;
                    setTimeout(() => {
                        this.isLevelCleared = false;
                        this.generateLevel();
                    }, 1500); // 1.5 second animation
                } else {
                    this.endGame(false);
                }
            }

            draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                this.drawQuestion();
                this.platforms.forEach(p => p.draw());
                this.player.draw();
            }
            
            drawQuestion() {
                if (!this.currentQuestion) return;
                ctx.fillStyle = '#ffcc00';
                ctx.textAlign = 'center';
                ctx.font = '24px Inter';
                ctx.fillText(this.currentQuestion.question, canvas.width / 2, 50);
            }

            async endGame(isWinner) {
                this.gameOver = true;
                gameUI.classList.add('hidden');
                gameOverScreen.classList.remove('hidden');

                if (isWinner) {
                    document.getElementById('game-over-title').textContent = 'Congratulations!';
                    finalLevelDisplay.textContent = 'All levels completed!';
                } else {
                    document.getElementById('game-over-title').textContent = 'Game Over!';
                    finalLevelDisplay.textContent = this.level;
                }
                finalScoreDisplay.textContent = this.score;

                // Save score to database
                const scoreData = { username: username, score: this.score };
                try {
                    const highScoreDocRef = doc(db, `artifacts/${appId}/public/data/high_scores`, 'top_scores');
                    const docSnap = await getDoc(highScoreDocRef);
                    let scores = docSnap.exists() ? docSnap.data().scores : [];
                    scores.push(scoreData);
                    scores.sort((a, b) => b.score - a.score);
                    scores = scores.slice(0, 5); // Keep only the top 5
                    await setDoc(highScoreDocRef, { scores: scores });
                    console.log("Score saved!");
                } catch (error) {
                    console.error("Error saving score:", error);
                }
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // UI Navigation Functions
        function showScreen(screen) {
            mainMenuScreen.classList.add('hidden');
            playScreen.classList.add('hidden');
            achievementsScreen.classList.add('hidden');
            creditsScreen.classList.add('hidden');
            gameUI.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        function handleStartGame() {
            username = usernameInput.value || 'Anonymous';
            showScreen(gameUI);
            game = new Game();
        }

        async function fetchHighScores() {
            showScreen(achievementsScreen);
            highScoreList.innerHTML = '<p>Loading...</p>';
            try {
                const highScoreDocRef = doc(db, `artifacts/${appId}/public/data/high_scores`, 'top_scores');
                const docSnap = await getDoc(highScoreDocRef);
                const scores = docSnap.exists() ? docSnap.data().scores : [];
                
                if (scores.length > 0) {
                    highScoreList.innerHTML = '';
                    scores.forEach((score, index) => {
                        const scoreItem = document.createElement('div');
                        scoreItem.className = 'list-item';
                        scoreItem.innerHTML = `<span>${index + 1}. ${score.username}</span><span>${score.score}</span>`;
                        highScoreList.appendChild(scoreItem);
                    });
                } else {
                    highScoreList.innerHTML = '<p class="text-center">No high scores yet!</p>';
                }

            } catch (error) {
                console.error("Error fetching high scores:", error);
                highScoreList.innerHTML = '<p class="text-center">Error loading scores.</p>';
            }
        }
        
        // Event Listeners
        playButton.addEventListener('click', () => showScreen(playScreen));
        achievementsButton.addEventListener('click', fetchHighScores);
        creditsButton.addEventListener('click', () => showScreen(creditsScreen));
        startGameButton.addEventListener('click', handleStartGame);
        restartButton.addEventListener('click', handleStartGame);
        quitButton.addEventListener('click', () => showScreen(mainMenuScreen));
        backToMainMenuButton.addEventListener('click', () => showScreen(mainMenuScreen));
        backToMenuFromAchievementsButton.addEventListener('click', () => showScreen(mainMenuScreen));
        backToMenuFromCreditsButton.addEventListener('click', () => showScreen(mainMenuScreen));
        
        // Initial setup
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized and user signed in:", auth.currentUser.uid);
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        initFirebase();
    </script>
</body>
</html>
